import Koa from 'koa';
import Router from 'koa-router';
import swagger from 'koa2-swagger-ui';
import proxy from 'koa-proxy';
import staticMiddleware from 'koa-static';
import loadView from '@bmo/loadView';
import loadMiddleware from './loadMiddleware';
import routes from './routes';
import views from './views';
import swagger from './swagger'
export default async (config) => {
	const { port } = config.server;
	const app = new Koa();
	loadMiddleware(config, app);
	loadRoutes(config, app);
	loadViews(config, app);
	start(port, app);
	return app;
};

const start = (port, app) => {
	app.listen(port);
	console.log(`Listening on port:${port}`);
};

const loadRoutes = (config, app) => {
	const routeInstances = routes(config);
  swagger(routeInstances, app, Router)
	app.use(routeInstances.routes(), routeInstances.allowedMethods());
};

const loadViews = (config, app) => {
	const viewRouter = new Router();

	views.forEach((view) => {
		loadView(config, app, viewRouter, view, proxy, staticMiddleware);
	});
	app.use(viewRouter.routes());
};


