import Koa from 'koa';
import Router from 'koa-router';
import swagger from 'koa2-swagger-ui';
import proxy from 'koa-proxy';
import staticMiddleware from 'koa-static';
import createSwaggerDefinition from '@bmo/createSwaggerDefinition';
import loadMiddleware from './loadMiddleware';
import loadView from '@bmo/loadView';
import routes from './routes';
import views from './views';
export default async (config) => {
	const { port } = config.server;
	const app = new Koa();
	loadMiddleware(config, app);
	loadRoutes(config, app);
	loadViews(config, app);
	start(port, app);
	return app;
};

const start = (port, app) => {
	app.listen(port);
	console.log(`Listening on port:${port}`);
};

const loadRoutes = (config, app) => {
	const routeInstances = routes(config);
	configureSwagger(routeInstances, app);
	app.use(routeInstances.routes(), routeInstances.allowedMethods());
};

const loadViews = (config, app) => {
	const viewRouter = new Router();

	views.forEach((view) => {
		loadView(config, app, viewRouter, view, proxy, staticMiddleware);
	});
	app.use(viewRouter.routes());
};

const configureSwagger = (routes, app) => {
	const swaggerDef = createSwaggerDefinition(routes.paths);
	console.log(swaggerDef);
	const router = new Router();
	router.get('/api/docs', (ctx) => {
		ctx.body = swaggerDef;
		ctx.status = 200;
	});
	router.get('/docs', (ctx) => {
		ctx.body = `
              <!DOCTYPE html>
              <html>
                <head>
                  <title>ReDoc</title>
                  <!-- needed for adaptive design -->
                  <meta charset="utf-8"/>
                  <meta name="viewport" content="width=device-width, initial-scale=1">
                  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:300,400,700" rel="stylesheet">

                  <!--
                  ReDoc doesn't change outer page styles
                  -->
                  <style>
                    body {
                      margin: 0;
                      padding: 0;
                    }
                  </style>
                </head>
                <body>
                  <redoc spec-url='/api/docs'></redoc>
                  <script src="https://cdn.jsdelivr.net/npm/redoc@2.0.0-alpha.17/bundles/redoc.standalone.js"> </script>
                </body>
              </html>
`;
	});
	app.use(router.routes());
	// app.use(swagger({
	// 	swaggerOptions: {
	// 		url: '/api/docs' // example path to json
	// 	}
	// }))
};
